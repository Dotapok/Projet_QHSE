{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Dashboard | Tableau des accidents</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="{% static 'assets/img/favicon.png' %}" rel="icon" />
    <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}"
      rel="stylesheet"
    />
    <link
      href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}"
      rel="stylesheet"
    />
    <link href="{% static 'assets/vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/quill/quill.snow.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/quill/quill.bubble.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/remixicon/remixicon.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/css/theme.min.css' %}" rel="stylesheet" id="style-default" />
    <link
      href="{% static 'assets/css/user-rtl.min.css' %}"
      rel="stylesheet"
      id="user-style-rtl"
    />
    <link
      href="{% static 'assets/css/user.min.css' %}"
      rel="stylesheet"
      id="user-style-default"
    />

    <!-- Inclure pdf-lib depuis un CDN -->
    <script src="https://unpkg.com/pdf-lib@latest/dist/pdf-lib.min.js"></script>

    <!-- Template Main CSS File -->
    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

    <!-- =======================================================
  * Template Name: NiceAdmin
  * Updated: Nov 17 2023 with Bootstrap v5.3.2
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  </head>

  <body>
        <!-- ======= Header ======= -->
        <header id="header" class="header fixed-top d-flex align-items-center">
          <div class="d-flex align-items-center justify-content-between">
            <a href="#" class="logo d-flex align-items-center">
              <img src="{% static 'assets/img/logo.png' %}" alt="" />
              <span class="d-none d-lg-block">DIGI QHSE</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
          </div>
          <!-- End Logo -->
    
        
    
          <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
              <li class="nav-item d-block d-lg-none">
                <a class="nav-link nav-icon search-bar-toggle" href="#">
                  <i class="bi bi-search"></i>
                </a>
              </li>
              <!-- End Search Icon-->
    
              <li class="nav-item dropdown">
                <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
                  <i class="bi bi-bell"></i>
                  <span class="badge bg-primary badge-number">4</span> </a
                ><!-- End Notification Icon -->
    
                <ul
                  class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications"
                >
                  <li class="dropdown-header">
                    You have 4 new notifications
                    <a href="#"
                      ><span class="badge rounded-pill bg-primary p-2 ms-2"
                        >View all</span
                      ></a
                    >
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
    
                  <li class="notification-item">
                    <i class="bi bi-exclamation-circle text-warning"></i>
                    <div>
                      <h4>Lorem Ipsum</h4>
                      <p>Quae dolorem earum veritatis oditseno</p>
                      <p>30 min. ago</p>
                    </div>
                  </li>
    
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
    
                  <li class="notification-item">
                    <i class="bi bi-x-circle text-danger"></i>
                    <div>
                      <h4>Atque rerum nesciunt</h4>
                      <p>Quae dolorem earum veritatis oditseno</p>
                      <p>1 hr. ago</p>
                    </div>
                  </li>
    
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
    
                  <li class="notification-item">
                    <i class="bi bi-check-circle text-success"></i>
                    <div>
                      <h4>Sit rerum fuga</h4>
                      <p>Quae dolorem earum veritatis oditseno</p>
                      <p>2 hrs. ago</p>
                    </div>
                  </li>
    
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
    
                  <li class="notification-item">
                    <i class="bi bi-info-circle text-primary"></i>
                    <div>
                      <h4>Dicta reprehenderit</h4>
                      <p>Quae dolorem earum veritatis oditseno</p>
                      <p>4 hrs. ago</p>
                    </div>
                  </li>
    
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li class="dropdown-footer">
                    <a href="#">Show all notifications</a>
                  </li>
                </ul>
                <!-- End Notification Dropdown Items -->
              </li>
              <!-- End Notification Nav -->
    
              <li class="nav-item dropdown pe-3">
                <a
                  class="nav-link nav-profile d-flex align-items-center pe-0"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <img
                    src="{{ profile_image_url }}"
                    alt="Profile"
                    class="rounded-circle"
                  />
                  <span class="d-none d-md-block dropdown-toggle ps-2"
                    >{{ nom }}</span
                  > </a
                ><!-- End Profile Iamge Icon -->
    
                <ul
                  class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile"
                >
                  <li class="dropdown-header">
                    <h6>{{ nom }}</h6>
                    <span>{{ fonction }}</span>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>

                  <li>
                    <hr class="dropdown-divider" />
                  </li>
    
                  <li>
                    <a class="dropdown-item d-flex align-items-center" href="{% url 'deconnexionprocessus' %}">
                      <i class="bi bi-box-arrow-right"></i>
                      <span>Se deconnecter</span>
                    </a>
                  </li>
                </ul>
                <!-- End Profile Dropdown Items -->
              </li>
              <!-- End Profile Nav -->
            </ul>
          </nav>
          <!-- End Icons Navigation -->
        </header>
        <!-- End Header -->
    
        <!-- ======= Sidebar ======= -->
        <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link collapsed" href="{% url 'Dashboard' %}">
            <i class="bi bi-grid"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <!-- End Dashboard Nav -->

        <li class="nav-item">
          <a class="nav-link collapsed" href="{% url 'AjouterAccident' %}">
            <i class="bi bi-journal-text"></i>
            <span>Ajouter un accident</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link collapsed" href="{% url 'AjouterIncident' %}">
            <i class="bi bi-journal-text"></i>
            <span>Ajouter un incident</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link " href="{% url 'tableauAccident' %}">
            <i class="bi bi-journal-text"></i>
            <span>Tableau des accidents</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link collapsed" href="{% url 'tableauAction' %}">
            <i class="bi bi-table"></i>
            <span>Tableau des actions</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link collapsed" href="{% url 'profile' %}">
            <i class="bi bi-person"></i>
            <span>Profile</span>
          </a>
        </li>
      </ul>
    </aside>
        <!-- End Sidebar-->

    <main id="main" class="main">
      <section class="section" style="padding-top: 0">
        <div class="row">
          <div class="card-body container mt-2 card p-4">
            <h2 class="fw-bold">Tableau de suivi des accidents</h2>

            <!-- Table with stripped rows -->
            <div
              class="tab-pane preview-tab-pane active"
              role="tabpanel"
              aria-labelledby="tab-dom-88202497-593f-464d-888e-68d67a1d9bd3"
              id="dom-88202497-593f-464d-888e-68d67a1d9bd3"
            >
              <div
                id="tableExample3"
                data-list='{"valueNames":["id","titre","date","victime","type","lieu"],"page":7,"pagination":true}'
              >
                <div class="row justify-content-end g-0">
                  <div class="col-auto col-sm-5 mb-3">
                    <form>
                      <div class="input-group">
                        <input
                          class="form-control form-control-sm shadow-none search"
                          type="search"
                          placeholder="Search..."
                          aria-label="search"
                        />
                        <div class="input-group-text bg-transparent">
                          <span class="fa fa-search fs-10 text-600"></span>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
                <div class="table-responsive scrollbar">
                  <table
                    class="table table-bordered table-hover table-striped fs-10 mb-0"
                  >
                    <thead>
                      <tr>
                        <th class="text-10000">id</th>
                        <th class="text-10000 sort" data-sort="titre">
                          Titre de l'événement
                        </th>
                        <th
                          class="text-10000 sort"
                          data-sort="date"
                          data-type="date"
                          data-format="YYYY/DD/MM"
                        >
                          Date
                        </th>
                        <th class="text-10000 sort" data-sort="victime">
                          Victime
                        </th>
                        <th class="text-10000 sort" data-sort="type">Type</th>
                        <th class="text-10000 sort" data-sort="lieu">Lieu</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody class="list" id="accident_tab"></tbody>
                  </table>
                </div>
                <div class="d-flex justify-content-center mt-3">
                  <button
                    class="btn btn-sm btn-falcon-default me-1"
                    type="button"
                    title="Previous"
                    data-list-pagination="prev"
                  >
                    <span class="fas fa-chevron-left"></span>
                  </button>
                  <ul class="pagination mb-0"></ul>
                  <button
                    class="btn btn-sm btn-falcon-default ms-1"
                    type="button"
                    title="Next"
                    data-list-pagination="next"
                  >
                    <span class="fas fa-chevron-right"> </span>
                  </button>
                </div>
              </div>
            </div>
            <!-- End Table with stripped rows -->
          </div>
        </div>
      </section>
      <!-- Modal pour bloquer l'interaction -->
      <div
        class="modal"
        id="loadingModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="loadingModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <!-- Toast au centre du modal -->
              <div
                id="loadingToast"
                class="toast"
                role="alert"
                aria-live="assertive"
                aria-atomic="true"
                data-bs-autohide="false"
              >
                <div class="toast-header">
                  <strong class="me-auto">Chargement</strong>
                </div>
                <div class="toast-body">
                  Génération du fichier PDF en cours...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>DIGI QHSE</span></strong
        >. All Rights Reserved
      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
        Designed by <a href="http://qse-expert.com/">qse-expert</a>
      </div>
    </footer>
    <!-- End Footer -->

    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>
    <!-- Vendor JS Files -->

    <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <script src="{% static 'assets/vendor/quill/quill.min.js' %}"></script>

    <script src="{% static 'assets/vendor/tinymce/tinymce.min.js' %}"></script>

    <!-- ===============================================--><!--    JavaScripts--><!-- ===============================================-->
    <script src="{% static 'assets/vendor/popper/popper.min.js' %}"></script>
    <script src="{% static 'assets/vendor/anchorjs/anchor.min.js' %}"></script>
    <script src="{% static 'assets/vendor/is/is.min.js' %}"></script>
    <script src="{% static 'assets/vendor/prism/prism.js' %}"></script>
    <script src="{% static 'assets/vendor/fontawesome/all.min.js' %}"></script>
    <script src="{% static 'assets/vendor/lodash/lodash.min.js' %}"></script>

    <script src="{% static 'assets/js/theme.js' %}"></script>
    <!-- Template Main JS File -->
    <script src="{% static 'assets/js/main.js' %}"></script>
    <script src="{% static 'assets/vendor/list.js/list.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@^1.16.0/dist/pdf-lib.min.js"></script>

    <script>
      let accidentList;

      document.addEventListener("DOMContentLoaded", function () {
        axios.get('{% url 'tableauAccidentListe' %}')
        .then(response => {
          const accidentData = response.data.accidentData;
          const tableBody = document.getElementById("accident_tab");
          accidentData.forEach((accident, index) => {
          let row = tableBody.insertRow();
          row.innerHTML = `
        <td class="id">${accident.id}</td>
        <td class="titre">${accident.titreEvenement}</td>
        <td class="date">${accident.date_accident}</td>
        <td class="victime">${accident.accident_Victime__nom_victime}</td>
        <td class="type">${accident.typeEvenement}</td>
        <td class="lieu">${accident.lieu}</td>
`;

          // Ajouter ici les actions avec icônes à chaque ligne
          let actionsCell = row.insertCell(6);
          actionsCell.innerHTML = `
          <i class="btn btn-outline-primary btn-sm me-2 bi bi-pencil-square btn-edit-action" onclick="editAction(${accident.pk})"></i>
          <i class="btn btn-outline-danger btn-sm bi bi-trash-fill btn-delete-action" onclick="removeItem(${accident.pk})"></i>
          <i class="btn btn-outline-primary btn-sm me-2 bi bi-printer btn-edit-action" onclick="printPdf(${accident.pk})"></i>

        `;
        });
        // Initialize List.js here
        var options = {
          valueNames: ["titre", "date", "victime", "type", "lieu", "id"],
          page: 7,
          pagination: true,
        };

        accidentList = new List("tableExample3", options);
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });

      function removeItem(itemId) {
        if (accidentList) {
          accidentList.remove("id", itemId);
        } else {
          showToast("L'accident n'a pas été trouvé dans la BD!", "error");
          return;
        }
      }

      async function printPdf(accidentId) {
        const { PDFDocument, StandardFonts, rgb } = PDFLib;

        // Trouver l'accident par ID

        const accident = accidents.find(
          (accident) => accident.id == accidentId
        );
        if (!accident) {
          showToast(
            "L'accident n'a pas été trouvé dans la Base de donée!",
            "error"
          );
          return;
        }

        // Afficher le modal et le toast de début de génération
        const loadingModal = new bootstrap.Modal(
          document.getElementById("loadingModal"),
          {
            backdrop: "static", // empêche de fermer en cliquant en dehors ou en appuyant sur ESC
            keyboard: false, // empêche la fermeture avec la touche échappe
          }
        );
        loadingModal.show();
        alert("Génération du pdf en cours...");
        // Charger le document PDF existant
        const url = "assets/déclaration_accident.pdf";
        const existingPdfBytes = await fetch(url).then((res) =>
          res.arrayBuffer()
        );

        // Charger un PDFDocument à partir des octets existants
        const pdfDoc = await PDFDocument.load(existingPdfBytes);

        // Obtenir le formulaire dans le PDF
        const form = pdfDoc.getForm();

        // Remplir les champs de formulaire avec les informations de l'accident
        form.getTextField("Texte1").setText(accident.tab1.numberCotisant);
        form.getTextField("Texte2").setText(accident.tab1.nameOrCorporateName);
        form.getTextField("Texte3").setText(accident.tab1.acronym);
        form.getTextField("Texte4").setText(accident.tab1.address);
        form.getTextField("Texte5").setText(accident.tab1.phoneNumber);
        form.getTextField("Texte6").setText(accident.tab1.fax);
        form.getTextField("Texte7").setText(accident.tab1.email);
        form.getTextField("Texte8").setText(accident.tab1.activitySector);
        form.getTextField("Texte9").setText(accident.tab1.numberOfEmployees);
        form
          .getTextField("Texte10")
          .setText(accident.tab2.socialSecurityNumber);
        form.getTextField("Texte11").setText(accident.tab2.fullName);
        form.getTextField("Texte12").setText(accident.tab2.gender);
        form.getTextField("Texte13").setText(accident.tab2.address);
        form.getTextField("Texte14").setText(accident.tab2.phoneNumber);
        form.getTextField("Texte15").setText(accident.tab2.fax);
        form.getTextField("Texte16").setText(accident.tab2.email);
        form.getTextField("Texte17").setText(accident.tab2.hiringDate);
        form.getTextField("Texte18").setText(accident.tab2.nationality);
        form.getTextField("Texte19").setText(accident.tab2.profession);
        form.getTextField("Texte20").setText(accident.tab2.jobPosition);
        form.getTextField("Texte21").setText(accident.tab2.seniority);
        form.getTextField("Texte22").setText(accident.tab2.spouseFullName);
        form.getTextField("Texte23").setText(accident.tab2.spousePhoneNumber);
        form.getTextField("Texte37").setText(accident.tab3.witnessName);
        form.getTextField("Texte39").setText(accident.tab3.witnessAddress);
        form.getTextField("Texte42").setText(accident.tab3.policeReport);
        form.getTextField("Texte40").setText(accident.tab3.reportAuthor);
        form.getTextField("Texte38").setText(accident.tab3.name);
        form.getTextField("Texte41").setText(accident.tab3.address);
        form.getTextField("Texte43").setText(accident.tab3.insuranceCompany);
        form.getTextField("Texte44").setText(accident.tab3.thirdParty);
        form.getTextField("Texte45").setText(accident.tab3.policyNumber);
        form.getTextField("Texte24").setText(accident.tab4.accidentDate);
        form.getTextField("Texte25").setText(accident.tab4.accidentTime);
        form.getTextField("Texte26").setText(accident.tab4.accidentLocation);
        form.getTextField("Texte27").setText(accident.tab4.workSchedule);
        form.getTextField("Texte28").setText(accident.tab4.natureOfLesions);
        form.getTextField("Texte29").setText(accident.tab4.locationOfLesions);
        form
          .getTextField("Texte30")
          .setText(accident.tab4.detailedCircumstances);
        form.getTextField("Texte31").setText(accident.tab4.causeOfAccident);
        form.getTextField("Texte32").setText(accident.tab3.name);

        // Enregistrer le PDF modifié
        const pdfBytes = await pdfDoc.save();

        // Télécharger le PDF rempli
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Declaration_Accident_" + accidentId + ".pdf";
        link.click();
        loadingModal.hide();
        alert("Le fichier PDF a été généré et téléchargé avec succès!");
      }

      // Fonction pour montrer le toast avec un message
      function showToast(message, type) {
        const pdfToast = document.getElementById("pdfToast");
        const toastBody = pdfToast.querySelector(".toast-body");
        toastBody.textContent = message;

        // Appliquer la classe correspondante au type de notification
        pdfToast.classList.remove(
          "text-bg-info",
          "text-bg-success",
          "text-bg-error"
        );
        if (type === "info") {
          pdfToast.classList.add("text-bg-info");
        } else if (type === "success") {
          pdfToast.classList.add("text-bg-success");
        } else if (type === "error") {
          pdfToast.classList.add("text-bg-danger");
        }

        // Afficher le toast
        var toast = new bootstrap.Toast(pdfToast);
        toast.show();
      }

      // Note: Assurez-vous d'avoir cette fonction dans la portée globale si vous l'utilisez dans un attribut `onclick`
      window.printPdf = printPdf;
    </script>
    <script src="assets/vendor/list.js/list.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@^1.16.0/dist/pdf-lib.min.js"></script>
  </body>
</html>
